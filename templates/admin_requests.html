{% extends "admin_base.html" %}

{% block title %}All Requests - Ops Platform{% endblock %}

{% block page_styles %}
/* Page Header - Subtle */
.page-header {
  margin-bottom: 28px;
}

.page-title {
  font-size: 26px;
  font-weight: 700;
  color: #0f172a;
  margin: 0 0 6px;
}

.page-subtitle {
  color: #64748b;
  font-size: 14px;
  margin: 0;
}

/* Toolbar */
.requests-toolbar {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  align-items: center;
}

.search-bar {
  flex: 1;
  min-width: 280px;
  position: relative;
}

.search-bar input {
  width: 100%;
  padding: 10px 14px 10px 38px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s;
}

.search-bar input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #94a3b8;
  font-size: 16px;
}

.date-range-picker {
  display: flex;
  gap: 8px;
  align-items: center;
}

.date-range-picker input {
  padding: 10px 12px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 13px;
  font-family: inherit;
  color: #475569;
}

.date-range-picker input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.export-btn {
  padding: 10px 18px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #475569;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: inherit;
}

.export-btn:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
  color: #1e293b;
}

/* Filters */
.filters-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}

.filters-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}

.filter-select {
  padding: 10px 14px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  background: white;
  color: #475569;
  cursor: pointer;
  transition: all 0.2s;
}

.filter-select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Table Card */
.table-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  overflow: hidden;
}

/* Row Count Indicator */
.table-header-bar {
  padding: 16px 20px;
  border-bottom: 1px solid #f1f5f9;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.row-count {
  font-size: 14px;
  color: #64748b;
  font-weight: 500;
}

.row-count strong {
  color: #1e293b;
}

/* Table */
.table-wrapper {
  overflow-x: auto;
  position: relative;
}

table {
  width: 100%;
  border-collapse: collapse;
}

/* Sticky Header */
thead {
  position: sticky;
  top: 0;
  background: #f8fafc;
  z-index: 10;
}

thead th {
  padding: 14px 16px;
  text-align: left;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  color: #64748b;
  letter-spacing: 0.05em;
  border-bottom: 2px solid #e2e8f0;
}

tbody tr {
  border-bottom: 1px solid #f1f5f9;
  cursor: pointer;
  transition: background 0.15s;
}

/* Row Hover State */
tbody tr:hover {
  background: #f8fafc;
}

/* Subtle Row Styling by Status */
tbody tr[data-status="approved"] {
  border-left: 3px solid #10b981;
}

tbody tr[data-status="denied"] {
  border-left: 3px solid #ef4444;
}

tbody tr[data-status="completed"] {
  border-left: 3px solid #8b5cf6;
}

tbody tr[data-status="pending"] {
  border-left: 3px solid #3b82f6;
}

tbody tr[data-status="in_progress"] {
  border-left: 3px solid #f59e0b;
}

tbody td {
  padding: 16px;
  font-size: 14px;
  color: #475569;
}

tbody td:first-child {
  padding-left: 20px;
}

/* Expandable Row Details */
.detail-row {
  display: none;
  background: #f8fafc;
}

.detail-row.expanded {
  display: table-row;
}

.detail-cell {
  padding: 24px 20px !important;
  border-top: 1px solid #e2e8f0;
}

.detail-content {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
}

.detail-section {
  background: white;
  padding: 16px;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.detail-section h4 {
  margin: 0 0 12px;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  color: #64748b;
  letter-spacing: 0.05em;
}

.detail-field {
  margin-bottom: 10px;
  font-size: 14px;
}

.detail-field:last-child {
  margin-bottom: 0;
}

.detail-label {
  font-weight: 600;
  color: #475569;
  display: inline-block;
  min-width: 120px;
}

.detail-value {
  color: #1e293b;
}

.admin-notes-box {
  background: #fffbeb;
  border: 1px solid #fcd34d;
  border-radius: 8px;
  padding: 16px;
  margin-top: 12px;
}

.admin-notes-box h5 {
  margin: 0 0 8px;
  font-size: 13px;
  font-weight: 700;
  color: #92400e;
}

.admin-notes-box p {
  margin: 0;
  font-size: 14px;
  color: #78350f;
  line-height: 1.6;
}

/* Chevron Icon */
.chevron-icon {
  display: inline-block;
  margin-right: 8px;
  transition: transform 0.2s;
  color: #94a3b8;
}

.chevron-icon.expanded {
  transform: rotate(90deg);
}

/* Go to Dashboard Button */
.goto-dashboard-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.2s;
  margin-top: 12px;
}

.goto-dashboard-btn:hover {
  background: #5568d3;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #94a3b8;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.empty-state h3 {
  margin: 0 0 8px;
  font-size: 18px;
  color: #475569;
}

.empty-state p {
  margin: 0;
  font-size: 14px;
}
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title">All Requests</h1>
  <p class="page-subtitle">Complete operational request history across all departments</p>
</div>

<!-- Toolbar -->
<div class="requests-toolbar">
  <!-- Search Bar -->
  <div class="search-bar">
    <span class="search-icon">üîç</span>
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Search by employee, request type, or category..."
      autocomplete="off"
    />
  </div>

  <!-- Date Range Picker -->
  <div class="date-range-picker">
    <input type="date" id="dateFrom" />
    <span style="color: #94a3b8;">to</span>
    <input type="date" id="dateTo" />
  </div>

  <!-- Export CSV Button -->
  <button class="export-btn" id="exportBtn">
    <span>üìä</span>
    Export CSV
  </button>
</div>

<!-- Filters -->
<div class="filters-card">
  <div class="filters-row">
    <select id="statusFilter" class="filter-select">
      <option value="all" {% if selected_status == 'all' %}selected{% endif %}>All Statuses</option>
      <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pending</option>
      <option value="in_progress" {% if selected_status == 'in_progress' %}selected{% endif %}>In Progress</option>
      <option value="completed" {% if selected_status == 'completed' %}selected{% endif %}>Completed</option>
      <option value="denied" {% if selected_status == 'denied' %}selected{% endif %}>Denied</option>
    </select>

    <select id="departmentFilter" class="filter-select">
      <option value="all">All Departments</option>
      <option value="corporate">Corporate</option>
      <option value="healthcare">Healthcare</option>
      <option value="legal">Legal</option>
    </select>

    <select id="categoryFilter" class="filter-select">
      <option value="all">All Categories</option>
      {% for c in categories %}
        <option value="{{ c }}">{{ c }}</option>
      {% endfor %}
    </select>

    <select id="priorityFilter" class="filter-select">
      <option value="all">All Priorities</option>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>
  </div>
</div>

<!-- Table -->
<div class="table-card">
  <!-- Row Count Indicator -->
  <div class="table-header-bar">
    <div class="row-count">
      Showing <strong id="visibleCount">{{ requests|length }}</strong> of <strong id="totalCount">{{ requests|length }}</strong> requests
    </div>
  </div>

  <!-- Table Wrapper with Sticky Header -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Employee</th>
          <th>Request</th>
          <th>Category</th>
          <th>Priority</th>
          <th>Department</th>
          <th>Status</th>
          <th>SLA</th>
          <th>Submitted</th>
          <th>Age</th>
        </tr>
      </thead>
      <tbody id="requestTableBody">
        {% if requests|length == 0 %}
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <h3>No requests found</h3>
                <p>There are no requests matching your criteria.</p>
              </div>
            </td>
          </tr>
        {% else %}
          {% for r in requests %}
          <tr class="request-row"
            data-id="{{ r['id'] }}"
            data-status="{{ r['status'] }}"
            data-category="{{ r['category'] }}"
            data-priority="{{ r['priority'] }}"
            data-department="{{ r['department'] }}"
            data-employee="{{ r['employee']|lower }}"
            data-request="{{ r['request_type']|lower }}"
            data-submitted="{{ r['created_at'] }}"
            onclick="toggleDetails('{{ r['id'] }}')">

            <td>
              <span class="chevron-icon" id="chevron-{{ r['id'] }}">‚ñ∂</span>
              {{ r["employee"] }}
            </td>
            <td><strong>{{ r["request_type"] }}</strong></td>
            <td>{{ r["category"] }}</td>
            <td class="priority-{{ r['priority'] }}">
              {{ r["priority"]|capitalize }}
            </td>
            <td>{{ r["department"]|capitalize }}</td>
            <td>
              <span class="badge {{ r['status'] }}">
                {{ r["status"]|capitalize }}
              </span>
            </td>
            <!-- SLA Column -->
             <td>
                {% if r.sla %}
                  {% if r.sla.breached %}
                    <span class="sla-breached">üî¥ Overdue</span>
                  {% else %}
                    <span class="sla-ok">üü¢ {{ r.sla.remaining_hours }}h left</span>
                  {% endif %}
                {% else %}
                  <span class="sla-na">‚Äî</span>
                {% endif %}
              </td>

            <td>{{ r["created_at"][:10] }}</td>
            <td>{{ r["age_days"] }}d</td>
          </tr>

          <!-- Expandable Detail Row -->
          <tr class="detail-row" id="details-{{ r['id'] }}" style="display:none;">
            <td colspan="9" class="detail-cell">
              <div class="detail-content">
                
                <!-- Request Details -->
                <div class="detail-section">
                  <h4>Request Details</h4>
                  <div class="detail-field">
                    <span class="detail-label">Request ID:</span>
                    <span class="detail-value">{{ r["id"] }}</span>
                  </div>
                  <div class="detail-field">
                    <span class="detail-label">Employee:</span>
                    <span class="detail-value">{{ r["employee"] }}</span>
                  </div>
                  <div class="detail-field">
                    <span class="detail-label">Request Type:</span>
                    <span class="detail-value">{{ r["request_type"] }}</span>
                  </div>
                  <div class="detail-field">
                    <span class="detail-label">Category:</span>
                    <span class="detail-value">{{ r["category"] }}</span>
                  </div>
                  <div class="detail-field">
                    <span class="detail-label">Priority:</span>
                    <span class="detail-value priority-{{ r['priority'] }}">{{ r["priority"]|capitalize }}</span>
                  </div>
                  <div class="detail-field">
                    <span class="detail-label">Department:</span>
                    <span class="detail-value">{{ r["department"]|capitalize }}</span>
                  </div>
                </div>

                <!-- Timeline -->
                <div class="detail-section">
                  <h4>Timeline</h4>
                  <div class="detail-field">
                    <span class="detail-label">Submitted:</span>
                    <span class="detail-value">{{ r["created_at"] }}</span>
                  </div>
                  {% if r["reviewed_at"] %}
                  <div class="detail-field">
                    <span class="detail-label">Reviewed:</span>
                    <span class="detail-value">{{ r["reviewed_at"] }}</span>
                  </div>
                  {% endif %}
                  {% if r["completed_at"] %}
                  <div class="detail-field">
                    <span class="detail-label">Completed:</span>
                    <span class="detail-value">{{ r["completed_at"] }}</span>
                  </div>
                  {% endif %}
                  <div class="detail-field">
                    <span class="detail-label">Age:</span>
                    <span class="detail-value">{{ r["age_days"] }} days</span>
                  </div>
                  <div class="detail-field">
                    <span class="detail-label">Current Status:</span>
                    <span class="badge {{ r['status'] }}">{{ r["status"]|capitalize }}</span>
                  </div>
                </div>

                

                <!-- Review Information -->
                <div class="detail-section">
                  <h4>Review Information</h4>
                  
                  {% if r["reviewed_by_email"] %}
                  <div class="detail-field">
                    <span class="detail-label">Reviewed By:</span>
                    <span class="detail-value">{{ r["reviewed_by_email"] }}</span>
                  </div>
                  {% else %}
                  <div class="detail-field">
                    <span class="detail-label">Reviewed By:</span>
                    <span class="detail-value" style="color: #94a3b8; font-style: italic;">
                      Not yet reviewed
                    </span>
                  </div>
                  {% endif %}

                  {% if r["admin_review_notes"] %}
                  <div class="admin-notes-box">
                    <h5>üìù Admin Review Notes</h5>
                    <p>{{ r["admin_review_notes"] }}</p>
                  </div>
                  {% endif %}

                  {% if r["status"] == "pending" %}
                  <form method="POST"
                    action="{{ url_for('dashboard.go_to_dashboard_from_requests') }}">
                    <input type="hidden" name="request_id" value="{{ r['id'] }}">
                    <button type="submit" class="goto-dashboard-btn">
                      ‚Üí Go to Dashboard to Review
                    </button>
                  </form> 
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
  console.log("Script loaded");

  // Toggle expandable row details
  function toggleDetails(requestId) {
    const detailRow = document.getElementById('details-' + requestId);
    const chevron = document.getElementById('chevron-' + requestId);
    if (!detailRow) return;

    if (detailRow.style.display === 'table-row') {
      detailRow.style.display = 'none';
      chevron.classList.remove('expanded');
    } else {
      detailRow.style.display = 'table-row';
      chevron.classList.add('expanded');
    }
  }

  // Wrap everything else in DOMContentLoaded
  document.addEventListener('DOMContentLoaded', function() {

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', applyFilters);

    // Date range filtering
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    dateFrom.addEventListener('change', applyFilters);
    dateTo.addEventListener('change', applyFilters);

    // Enhanced filter function
    function applyFilters() {
      console.log("applyFilters called");
      const status = document.getElementById('statusFilter').value;
      console.log("Status filter value:", status);

      const category = document.getElementById('categoryFilter').value;
      const priority = document.getElementById('priorityFilter').value;
      const department = document.getElementById('departmentFilter').value;
      const searchTerm = searchInput.value.toLowerCase();
      const fromDate = dateFrom.value;
      const toDate = dateTo.value;

      let visibleCount = 0;
      const allRows = document.querySelectorAll('.request-row');

      allRows.forEach(row => {
        const matchesStatus = status === 'all' || row.dataset.status === status;
        const matchesCategory = category === 'all' || row.dataset.category === category;
        const matchesPriority = priority === 'all' || row.dataset.priority === priority;
        const matchesDepartment = department === 'all' || row.dataset.department === department;
        
        const matchesSearch = searchTerm === '' || 
          row.dataset.employee.includes(searchTerm) ||
          row.dataset.request.includes(searchTerm) ||
          row.dataset.category.toLowerCase().includes(searchTerm);

        let matchesDateRange = true;
        if (fromDate || toDate) {
          const rowDate = row.dataset.submitted.split(' ')[0];
          if (fromDate && rowDate < fromDate) matchesDateRange = false;
          if (toDate && rowDate > toDate) matchesDateRange = false;
        }

        const shouldShow = matchesStatus && matchesCategory && matchesPriority && 
                          matchesDepartment && matchesSearch && matchesDateRange;

        if (shouldShow) {
          row.style.display = '';
          const detailRow = row.nextElementSibling;
          if (detailRow && detailRow.classList.contains('detail-row')) {
            detailRow.style.display = detailRow.classList.contains('expanded') ? 'table-row' : 'none';
          }
          visibleCount++;
        } else {
          row.style.display = 'none';
          const detailRow = row.nextElementSibling;
          if (detailRow && detailRow.classList.contains('detail-row')) {
            detailRow.style.display = 'none';
          }
        }
      });

      // Update row count
      document.getElementById('visibleCount').textContent = visibleCount;
    }

    // Export to CSV functionality
    document.getElementById('exportBtn').addEventListener('click', function() {
      const rows = document.querySelectorAll('.request-row');
      let csv = 'Employee,Request Type,Category,Priority,Department,Status,Submitted,Age (days)\n';

      rows.forEach(row => {
        if (row.style.display !== 'none') {
          const cells = row.querySelectorAll('td');
          const rowData = [];
          
          for (let i = 1; i < cells.length; i++) {
            let cellText = cells[i].textContent.trim();
            if (cellText.includes(',') || cellText.includes('"')) {
              cellText = '"' + cellText.replace(/"/g, '""') + '"';
            }
            rowData.push(cellText);
          }
          
          csv += rowData.join(',') + '\n';
        }
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'requests_export_' + new Date().toISOString().split('T')[0] + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    });

    // Attach listeners to filters
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('departmentFilter').addEventListener('change', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('priorityFilter').addEventListener('change', applyFilters);

    // Set total count on page load
    document.getElementById('totalCount').textContent = document.querySelectorAll('.request-row').length;

    // Run filter on page load
    applyFilters();
      
  });
</script>
{% endblock %}
{% extends "base.html" %}
{% block title %}My Requests{% endblock %}

{% block content %}
<div class="user-shell">



 <!-- User Sidebar -->
<aside class="user-sidebar">
  <div class="user-brand">Ops Platform</div>

  <nav class="user-nav">
    <a class="{{ 'active' if active_page == 'dashboard' else '' }}"
       href="{{ url_for('dashboard.user_dashboard') }}">
      Dashboard
    </a>

    <a class="{{ 'active' if active_page == 'requests' else '' }}"
       href="#">
      My Requests
    </a>

  <a class="{{ 'active' if active_page == 'knowledge_base' else '' }}"
    href="{{ url_for('dashboard.user_knowledge_base') }}">
    Knowledge Base
    </a>

    <a class="{{ 'active' if active_page == 'notifications' else '' }}"
       href="#">
      Notifications
    </a>

    <a class="{{ 'active' if active_page == 'profile' else '' }}"
       href="{{ url_for('dashboard.user_profile') }}">
      Profile
    </a>

    <a class="{{ 'active' if active_page == 'settings' else '' }}"
       href="#">
      Settings
    </a>

    <form method="POST" action="{{ url_for('auth.logout') }}">
      <button type="submit" class="btn user-logout">Logout</button>
    </form>
  </nav>
</aside>


  <!-- Main Content -->
  <main class="user-content">

    <div class="card">
      <h2 style="margin-top:0;">My Requests</h2>
      <div class="muted">Signed in as {{ user["email"] }}</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <span class="badge pending">Pending</span>
      <span class="badge approved" style="margin-left:8px;">Approved</span>
      <span class="badge denied" style="margin-left:8px;">Denied</span>
    </div>

    <h3 style="margin:24px 0 8px;">Recent Requests</h3>

    <table>
      <thead>
        <tr>
          <th>Request</th>
          <th>Category</th>
          <th>Status</th>
          <th>Submitted</th>
        </tr>
      </thead>

      <tbody id="my-requests-body">
        <tr>
          <td colspan="4">Loading requestsâ€¦</td>
        </tr>
      </tbody>
    </table>

    <div class="card" style="margin-top:24px;">
      <h3 style="margin-top:0;">Submit a New Request</h3>

      <form method="POST" action="{{ url_for('requests.create_request') }}">
        <div class="field">
          <input
            class="input"
            name="request_type"
            placeholder="Request type (e.g. VPN Access)"
            required
          >
        </div>

  <div class="field">
    <select class="input" name="category" required>
      <option value="">Select category</option>
      <option value="Access">Access</option>
      <option value="Hardware">Hardware</option>
      <option value="Software">Software</option>
      <option value="Account Management">Account Management</option>
      <option value="Onboarding">Onboarding</option>
      <option value="Offboarding">Offboarding</option>
      <option value="Facilities">Facilities</option>
      <option value="Security">Security</option>
  </select>
</div>

        <div class="field">
          <select class="input" name="priority" required>
            <option value="">Select priority</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>

        <button type="submit" class="btn">Submit Request</button>
      </form>
    </div>

  </main>
</div>

<script>
  console.log("User dashboard script loaded");

  fetch("/api/user/requests")
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById("my-requests-body");
      tbody.innerHTML = "";

      if (!data.length) {
        tbody.innerHTML = "<tr><td colspan='4'>No requests yet.</td></tr>";
        return;
      }

      // Updated user dashboard table rendering with professional admin notes
      data.forEach(r => {
        const row = document.createElement("tr");
        
        // Create unique ID for each note (for accessibility)
        const noteId = `note-${r.id}`;
        
        row.innerHTML = `
          <td>
            <strong>${r.request_type}</strong>
            ${
              r.admin_review_notes
                ? `
                <div class="admin-note-container">
                  <button class="admin-note-toggle" data-note-id="${noteId}">
                    <svg class="note-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>View Admin Note</span>
                    <svg class="chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </button>
                  <div class="admin-note-content" id="${noteId}">
                    <div class="admin-note-text">${r.admin_review_notes}</div>
                  </div>
                </div>
                `
                : ""
            }
          </td>
          <td>${r.category}</td>
          <td>
            <span class="badge ${r.status}">${r.status}</span>
          </td>
          <td class="muted">${r.created_at}</td>
        `;
        tbody.appendChild(row);
      });

    })  // <-- This closes the .then(data => {
    .catch(err => console.error("Fetch failed:", err));

  // Event delegation for admin note toggles (more reliable than onclick)
  document.addEventListener('click', function(e) {
    const button = e.target.closest('.admin-note-toggle');
    if (!button) return;
    
    const noteId = button.dataset.noteId;
    const content = document.getElementById(noteId);
    
    if (!content) {
      console.error('Could not find admin note content for ID:', noteId);
      return;
    }
    
    // Toggle the visibility
    if (content.classList.contains('show')) {
      content.classList.remove('show');
      button.classList.remove('active');
    } else {
      content.classList.add('show');
      button.classList.add('active');
    }
  });

</script>

{% endblock %}